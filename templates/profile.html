{% extends "signedInBase.html" %}

{% block title %}Profile – ShareSpace{% endblock %}

{% block nav_profile %}
{{ ACTIVE }}
{% endblock %}

{% block content %}

<!-- Top Bar -->
<div class="mb-8">
    <h1 class="text-3xl font-bold mb-1">My Profile</h1>
    <p class="text-body-color dark:text-dark-6">
        Manage your account information and swap history
    </p>
</div>

<!-- Success/Error Messages -->
{% if success %}
<div class="bg-green bg-opacity-10 border border-green text-green px-6 py-4 rounded-lg mb-6">
    <i class="fas fa-check-circle mr-2"></i>{{ success }}
</div>
{% endif %}

{% if error %}
<div class="bg-red bg-opacity-10 border border-red text-red px-6 py-4 rounded-lg mb-6">
    <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
</div>
{% endif %}

<!-- Profile Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Left Column - Profile Card -->
    <div class="lg:col-span-1">
        <div class="bg-white dark:bg-dark-2 rounded-xl p-6 shadow-lg">
            
            <!-- Profile Picture -->
            <div class="text-center mb-6">
                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-primary to-purple mx-auto flex items-center justify-center text-primary text-4xl font-bold mb-4">
                    {{ session.username[0].upper() }}
                </div>
                <h2 class="text-xl font-bold text-primary mb-1">
                    {{ session.username }}
                </h2>
                <p class="text-sm text-body-color">
                    {{ session.email }}
                </p>
                <p class="text-xs text-body-color mt-1">
                    <i class="fas fa-map-marker-alt mr-1"></i>{{ session.hostel or 'Campus' }}
                </p>
                <p class="text-xs text-body-color mt-1">
                    <i class="fas fa-phone mr-1"></i>{{ session.phone or 'No phone' }}
                </p>
            </div>


            <!-- Quick Actions -->
            <div class="space-y-2">
                <a href="{{ url_for('upload') }}" 
                   class="block w-full px-4 py-3 bg-primary text-white rounded-lg text-center font-semibold hover:bg-blue-dark transition">
                    <i class="fas fa-plus mr-2"></i>Add New Item
                </a>
                <button onclick="showTab('settings')" 
                   class="block w-full px-4 py-3 bg-blue-dark text-dark rounded-lg text-center font-semibold hover:bg-gray-2 dark:hover:bg-primary transition">
                    <i class="fas fa-cog mr-2"></i>Account Settings
                </button>
            </div>

            <!-- Member Since -->
            <div class="mt-6 pt-6 border-t border-stroke dark:border-dark-3 text-center">
                <p class="text-xs text-body-color dark:text-dark-6">
                    <i class="fas fa-calendar mr-1"></i>Member since {{ session.joined_date or 'Recently' }}
                </p>
            </div>
        </div>
    </div>

    <!-- Right Column - Tabs Content -->
    <div class="lg:col-span-2">
        
        <!-- Tabs -->
        <div class="bg-white dark:bg-dark-2 rounded-xl shadow-lg overflow-hidden">
            
            <!-- Tab Headers -->
            <div class="flex border-b border-stroke dark:border-dark-3 overflow-x-auto">
                <button onclick="showTab('active-listings')" 
                        id="tab-active-listings"
                        class="flex-1 px-6 py-4 font-semibold text-primary border-b-2 border-primary transition whitespace-nowrap">
                    Active Listings
                </button>
                <button onclick="showTab('swap-history')" 
                        id="tab-swap-history"
                        class="flex-1 px-6 py-4 font-semibold text-body-color dark:text-dark-6 hover:text-primary transition whitespace-nowrap">
                    Swap History
                </button>
                <button onclick="showTab('saved-items')" 
                        id="tab-saved-items"
                        class="flex-1 px-6 py-4 font-semibold text-body-color dark:text-dark-6 hover:text-primary transition whitespace-nowrap">
                    Saved Items
                </button>
                <button onclick="showTab('settings')" 
                        id="tab-settings"
                        class="flex-1 px-6 py-4 font-semibold text-body-color dark:text-dark-6 hover:text-primary transition whitespace-nowrap">
                    Settings
                </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                
                <!-- Active Listings Tab -->
                <div id="active-listings" class="tab-content">
                    {% if active_listings %}
                    <div class="space-y-4">
                        {% for item in active_listings %}
                        <div class="flex gap-4 p-4 bg-gray-1 dark:bg-dark rounded-lg hover:bg-gray-2 dark:hover:bg-dark-3 transition">
                            
                            <!-- Item Image -->
                            <div class="w-20 h-20 rounded-lg bg-gradient-to-br from-primary to-blue-dark flex items-center justify-center text-white text-2xl flex-shrink-0">
                                {% if item.image %}
                                <img src="{{ url_for('static', filename='uploads/' + item.image) }}" 
                                     class="w-full h-full object-cover rounded-lg" alt="{{ item.name }}">
                                {% else %}
                                <i class="fas fa-box"></i>
                                {% endif %}
                            </div>

                            <!-- Item Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-body-color dark:text-dark-6 mb-1">
                                    {{ item.name }}
                                </h3>
                                <p class="text-xs text-body-color dark:text-dark-6 mb-2">
                                    {{ item.category|capitalize }} • Listed {{ item.created_at }}
                                </p>
                                <p class="text-sm text-body-color dark:text-dark-6 line-clamp-1 mb-2">
                                    {{ item.description }}
                                </p>
                                <div class="flex gap-4 text-xs text-body-color dark:text-dark-6">
                                    <span><i class="fas fa-eye mr-1"></i>{{ item.views or 0 }} views</span>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex flex-col gap-2">
                                <a href="/item/{{ item.id }}" 
                                   class="px-4 py-2 bg-primary text-white text-sm rounded-lg hover:bg-blue-dark transition text-center whitespace-nowrap">
                                    View
                                </a>
                                <form method="POST" action="{{ url_for('delete_item', item_id=item.id) }}">
    <button type="submit"                                         class="px-4 py-2 bg-red bg-opacity-10 text-red text-sm rounded-lg hover:bg-opacity-20 transition whitespace-nowrap">
Delete</button>
</form>

 
                            </div>
                        </div>
                        
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-box-open text-5xl text-body-color dark:text-dark-6 opacity-50 mb-4"></i>
                        <h3 class="text-lg font-bold text-dark dark:text-white mb-2">No Active Listings</h3>
                        <p class="text-body-color dark:text-dark-6 mb-6">
                            You haven't listed any items yet
                        </p>
                        <a href="{{ url_for('upload') }}" 
                           class="inline-block px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-dark transition">
                            <i class="fas fa-plus mr-2"></i>Add Your First Item
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Swap History Tab -->
                <div id="swap-history" class="tab-content hidden">
                    {% if swap_history %}
                    <div class="space-y-4">
                        {% for swap in swap_history %}
                        <div class="flex gap-4 p-4 bg-gray-1 dark:bg-dark rounded-lg">
                            
                            <!-- Swap Icon -->
                            <div class="w-12 h-12 rounded-full bg-green bg-opacity-10 flex items-center justify-center text-green flex-shrink-0">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>

                            <!-- Swap Info -->
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-dark dark:text-white mb-1">
                                    Swap Completed
                                </h4>
                                <p class="text-sm text-body-color dark:text-dark-6 mb-1">
                                    {{ swap.name }}
                                </p>
                                <p class="text-xs text-body-color dark:text-dark-6">
                                    <i class="fas fa-calendar mr-1"></i>{{ swap.completed_at }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-exchange-alt text-5xl text-body-color dark:text-dark-6 opacity-50 mb-4"></i>
                        <h3 class="text-lg font-bold text-dark dark:text-white mb-2">No Swap History</h3>
                        <p class="text-body-color dark:text-dark-6 mb-6">
                            You haven't completed any swaps yet
                        </p>
                        <a href="{{ url_for('browse_items') }}" 
                           class="inline-block px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-dark transition">
                            <i class="fas fa-search mr-2"></i>Browse Items
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Saved Items Tab -->
                <div id="saved-items" class="tab-content hidden">
                    {% if saved_items %}
                    <div class="space-y-4">
                        {% for item in saved_items %}
                        <div class="flex gap-4 p-4 bg-gray-1 dark:bg-dark rounded-lg hover:bg-gray-2 dark:hover:bg-dark-3 transition">
                            
                            <!-- Item Image -->
                            <div class="w-20 h-20 rounded-lg bg-gradient-to-br from-purple to-pink-500 flex items-center justify-center text-white text-2xl flex-shrink-0">
                                {% if item.image %}
                                <img src="{{ url_for('static', filename='uploads/' + item.image) }}" 
                                     class="w-full h-full object-cover rounded-lg" alt="{{ item.name }}">
                                {% else %}
                                <i class="fas fa-box"></i>
                                {% endif %}
                            </div>

                            <!-- Item Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-body-color mb-1">
                                    {{ item.name }}
                                </h3>
                                <p class="text-xs text-body-color dark:text-dark-6 mb-2">
                                    {{ item.category|capitalize }} • By {{ item.owner_name }}
                                </p>
                            </div>

                            <!-- Actions -->
                            <div class="flex flex-col gap-2">
                                <a href="/item/{{ item.id }}" 
                                   class="px-4 py-2 bg-primary text-white text-sm rounded-lg hover:bg-blue-dark transition text-center whitespace-nowrap">
                                    View Item
                                </a>

                                   <form method="POST" action="{{ url_for('unsave_item', item_id=item.id) }}">
            <button type="submit" class="px-4 py-2 bg-gray-1 dark:bg-dark rounded-lg hover:bg-gray-2 dark:hover:bg-dark-3 transition">
                <i class="fas fa-heart-broken"></i>
            </button>
        </form>

                            </div>s
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-heart-broken text-5xl text-body-color dark:text-dark-6 opacity-50 mb-4"></i>
                        <h3 class="text-lg font-bold text-body-color mb-2">No Saved Items</h3>
                        <p class="text-body-color dark:text-dark-6 mb-6">
                            You haven't saved any items yet
                        </p>
                        <a href="{{ url_for('browse_items') }}" 
                           class="inline-block px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-dark transition">
                            <i class="fas fa-search mr-2"></i>Browse Items
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="tab-content hidden space-y-6">
                    
                    <!-- Change Password Section -->
                    <div class="bg-gray-1 dark:bg-dark rounded-xl p-6">
                        <h3 class="text-xl font-bold text-body-color  mb-4 flex items-center gap-2">
                            <i class="fas fa-lock text-body-color "></i>
                            Change Password
                        </h3>
                        
                        <form action="{{ url_for('change_password') }}" method="POST" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Current Password
                                </label>
                                <input type="password" name="current_password" required
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    New Password
                                </label>
                                <input type="password" name="new_password" required minlength="6"
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Confirm New Password
                                </label>
                                <input type="password" name="confirm_password" required minlength="6"
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <button type="submit" 
                                    class="w-full px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-dark transition">
                                <i class="fas fa-check mr-2"></i>Update Password
                            </button>
                        </form>
                    </div>

                    <!-- Edit Profile Section -->
                    <div class="bg-gray-1 dark:bg-dark rounded-xl p-6">
                        <h3 class="text-xl font-bold text-body-color mb-4 flex items-center gap-2">
                            <i class="fas fa-user-edit text-primary"></i>
                            Edit Profile Information
                        </h3>
                        
                        <form action="{{ url_for('update_profile') }}" method="POST" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Username
                                </label>
                                <input type="text" name="username" value="{{ session.username }}" required
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Email
                                </label>
                                <input type="email" name="email" value="{{ session.email }}" required
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Phone Number
                                </label>
                                <input type="tel" name="phone" value="{{ session.phone or '' }}"
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-body-color mb-2">
                                    Hostel/Location
                                </label>
                                <input type="text" name="hostel" value="{{ session.hostel or '' }}"
                                       class="w-full px-4 py-3 bg-white dark:bg-dark-2 border border-stroke dark:border-dark-3 rounded-lg text-body-color focus:border-primary focus:outline-none transition">
                            </div>
                            
                            <button type="submit" 
                                    class="w-full px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-dark transition">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </form>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red bg-opacity-5 border-2 border-red border-opacity-20 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-red mb-2 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Danger Zone
                        </h3>
                        <p class="text-sm text-body-color dark:text-dark-6 mb-4">
                            Once you delete your account, there is no going back. All your listings and data will be permanently deleted.
                        </p>
                        
                        <button onclick="confirmDeleteAccount()" 
                                class="px-6 py-3 bg-red-900 text-body-color dark:text-dark-6 rounded-lg font-semibold hover:bg-opacity-80 transition">
                            <i class="fas fa-trash mr-2"></i>Delete Account
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<script>
function showTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Remove active state from all tabs
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.classList.remove('text-primary', 'border-b-2', 'border-primary');
        tab.classList.add('text-body-color', 'dark:text-dark-6');
    });

    // Show selected tab content
    document.getElementById(tabId).classList.remove('hidden');

    // Add active styling to selected tab
    const activeTab = document.getElementById('tab-' + tabId);
    if (activeTab) {
        activeTab.classList.remove('text-body-color', 'dark:text-dark-6');
        activeTab.classList.add('text-primary', 'border-b-2', 'border-primary');
    }

    // Update URL hash
    window.location.hash = tabId;
}



function unsaveItem(itemId) {
    fetch(`/unsave-item/${itemId}`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Failed to unsave item");
        }
    });
}


function confirmDeleteAccount() {
    if (confirm('⚠️ WARNING: This action cannot be undone!\n\nAre you absolutely sure you want to delete your account?\n\nAll your listings, swap history, and personal data will be permanently deleted.')) {
        if (confirm('This is your final confirmation. Type DELETE to proceed.')) {
            window.location.href = '{{ url_for("delete_account") }}';
        }
    }
}

document.addEventListener("DOMContentLoaded", function () {
    const hash = window.location.hash;

    if (hash) {
        showTab(hash.replace('#', ''));
    }
});
</script>

{% endblock %}